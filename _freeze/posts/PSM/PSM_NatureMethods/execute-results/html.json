{
  "hash": "b90a87e2df4ed7b3b4235273e8e577b2",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Nature Methods: Propensity score matching\"\ndate: \"2024-10-11\"\ndate-modified: today\ncategories: [propensity score]\n---\n\n\n## [Propensity score matching (Nature Methods)](https://www.nature.com/articles/s41592-024-02405-4)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Simulate a study of bone density (bd) in a cohort of non-smokers and smokers.\n\ncohort_size = 1000\n\n# Bone density (bd) units g/cm^2 expressed as \"T score\" relative to young population. \n# https://www.researchgate.net/publication/259608747_Age-Related_Changes_in_the_Prevalence_of_Osteoporosis_according_to_Gender_and_Skeletal_Site_The_Korea_National_Health_and_Nutrition_Examination_Survey_2008-2010\n# https://www.chatswooddensitometry.com.au/bone-density-results.html\n# T = 0 corresponds to about 1.2 g/cm^2\n#\n#              -2.5         -1.0\n# <--------------|------------|----------->\n#   osteoporosis   osteopenia   normal\n\nsmoking_bd_true_effect           = -0.5\nmax_individual_covariate_effect  = -0.5\n\n# \"treatment\" refers to membership in smoking group\n# covariate_effect - 0/1 - whether covariates impact bone density (for testing)\n# treatment_effect - 0/1 - whether smoking impacts bone density (for testing)\nmake_cohort = function(covariate_effect=0,treatment_effect=0,seed,n=cohort_size) {\nset.seed(seed)\nblood = tibble(\n  id      = 1:n,\n  #############################################################\n  # ALCOHOL\n  # g/day\n  # https://pophealthmetrics.biomedcentral.com/articles/10.1186/1478-7954-10-6/tables/2\n  # Distribution below from Table 2 (male, USA2)\n  # Min.  1st Qu.   Median     Mean  3rd Qu.     Max.    sd\n  # 0.0003   1.8410   7.5948  14.5125  19.2759 142.6630 19\n  alcohol = rgamma(cohort_size,scale=25.65,shape=0.53),\n  #############################################################\n  # STRESS\n  # perceived stress scale (PSS), 0-40\n  # https://www.slu.edu/medicine/family-medicine/pdfs/perceived-stress-scale.pdf\n  # Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    sd\n  # 0.5266  6.9912 11.6250 12.4698 16.8827 37.3044  7.0\n  stress_base  = bound(50*rbeta(cohort_size,2,6),c(0,40)),\n  #############################################################\n  # CAFFEINE\n  # mg/day\n  # https://www.ncbi.nlm.nih.gov/books/NBK202226/\n  # table 2-1 avg 165 90% 379\n  # Min.  1st Qu.  Median    Mean 3rd Qu.    Max.  90% \n  # 0.034  75.355 166.391 200.789 294.416 773.001  428\n  caffeine = 800*rbeta(cohort_size,1,3),\n) %>% \n  mutate(\n         # +0.5 stress for each alcohol g/day (arbitrary increase)\n         # e.g. those in 75% of alcohol consumption drink 18 g/day = +9 stress ~ s.d. of stress distribution\n         alcohol_stress_effect = alcohol / 2,\n         stress = bound(stress_base + alcohol_stress_effect,c(0,40))) %>%\n  mutate(bd_base             = rnorm(cohort_size,0,0.5),\n         bd_covariate_effect = max_individual_covariate_effect*(\n                                  rescale(stress,  to=c(0,1)) + \n                                  rescale(alcohol, to=c(0,1)) + \n                                  rescale(caffeine,to=c(0,1)))) %>%\n  # Each covariate (arbitrarily) contributes equally to the treatment score\n  # based on subject's percentile value in the covariate's distribution.\n  # The score is then rescaled to a probability in the range [0,1], which is then used\n  # to generate assignment to control (treatment = 0) or treatment (treatment = 1) groups.\n  mutate(\n         treatment_score  = rescale(stress,  to=c(0,1)) + \n                            rescale(alcohol, to=c(0,1)) + \n                            rescale(caffeine,to=c(0,1)), \n         treatment_p      = rescale(treatment_score, to = c(0.1,0.9)),\n         treatment        = rbinom(cohort_size, 1, treatment_p)) %>% \n  # Bone density\n  mutate(\n         # reduction in bd if subject is a smoker\n         bd_treatment_effect = treatment*smoking_bd_true_effect,\n         # final bd, including covariate effects (if toggled) and treatment effect (if toggled)\n         bd = bd_base + covariate_effect*bd_covariate_effect + treatment_effect*bd_treatment_effect)\n}\n\n# 1. Pick a seed\nseed = 20 \n# 2. Cohort A : no treatment or covariate effects\ncohort_a = make_cohort(seed=seed,covariate_effect=0,treatment_effect=0)\npsych::describeBy(stress + alcohol + caffeine + bd ~ treatment, data = cohort_a)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Descriptive statistics by group \ntreatment: 0\n         vars   n   mean     sd median trimmed    mad   min    max  range skew\nstress      1 651  16.92   9.24  15.71   16.17   9.20  0.88  40.00  39.12 0.65\nalcohol     2 651  10.78  15.06   5.10    7.63   6.89  0.00 108.19 108.19 2.68\ncaffeine    3 651 180.24 145.66 140.32  163.46 144.68  0.22 693.09 692.87 0.89\nbd          4 651   0.03   0.51   0.03    0.03   0.53 -1.27   1.46   2.74 0.00\n         kurtosis   se\nstress      -0.10 0.36\nalcohol      9.34 0.59\ncaffeine     0.08 5.71\nbd          -0.36 0.02\n------------------------------------------------------------ \ntreatment: 1\n         vars   n   mean     sd median trimmed    mad   min    max  range  skew\nstress      1 349  21.46  10.47  20.48   21.18  12.20  0.62  40.00  39.38  0.21\nalcohol     2 349  18.47  23.38   9.47   13.97  12.96  0.00 142.97 142.97  2.30\ncaffeine    3 349 231.16 166.58 199.42  217.70 187.19  1.69 708.31 706.62  0.61\nbd          4 349   0.01   0.52  -0.02    0.01   0.56 -1.38   1.57   2.95 -0.01\n         kurtosis   se\nstress      -0.96 0.56\nalcohol      6.69 1.25\ncaffeine    -0.58 8.92\nbd          -0.27 0.03\n```\n\n\n:::\n\n```{.r .cell-code}\n# 3. Cohort B : covariate effect, no treatment effect\ncohort_b = make_cohort(seed=seed,covariate_effect=1,treatment_effect=0)\npsych::describeBy(stress + alcohol + caffeine + bd ~ treatment, data = cohort_b)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Descriptive statistics by group \ntreatment: 0\n         vars   n   mean     sd median trimmed    mad   min    max  range skew\nstress      1 651  16.92   9.24  15.71   16.17   9.20  0.88  40.00  39.12 0.65\nalcohol     2 651  10.78  15.06   5.10    7.63   6.89  0.00 108.19 108.19 2.68\ncaffeine    3 651 180.24 145.66 140.32  163.46 144.68  0.22 693.09 692.87 0.89\nbd          4 651  -0.34   0.55  -0.35   -0.34   0.59 -1.78   1.19   2.97 0.03\n         kurtosis   se\nstress      -0.10 0.36\nalcohol      9.34 0.59\ncaffeine     0.08 5.71\nbd          -0.28 0.02\n------------------------------------------------------------ \ntreatment: 1\n         vars   n   mean     sd median trimmed    mad   min    max  range  skew\nstress      1 349  21.46  10.47  20.48   21.18  12.20  0.62  40.00  39.38  0.21\nalcohol     2 349  18.47  23.38   9.47   13.97  12.96  0.00 142.97 142.97  2.30\ncaffeine    3 349 231.16 166.58 199.42  217.70 187.19  1.69 708.31 706.62  0.61\nbd          4 349  -0.48   0.57  -0.46   -0.48   0.61 -2.08   1.32   3.40 -0.01\n         kurtosis   se\nstress      -0.96 0.56\nalcohol      6.69 1.25\ncaffeine    -0.58 8.92\nbd          -0.19 0.03\n```\n\n\n:::\n\n```{.r .cell-code}\n#hist(cohort$bp)\n# 4. Cohort C : covariate and treatment effects\ncohort_c = make_cohort(seed=seed,covariate_effect=1,treatment_effect=1)\npsych::describeBy(stress + alcohol + caffeine + bd ~ treatment, data = cohort_c)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Descriptive statistics by group \ntreatment: 0\n         vars   n   mean     sd median trimmed    mad   min    max  range skew\nstress      1 651  16.92   9.24  15.71   16.17   9.20  0.88  40.00  39.12 0.65\nalcohol     2 651  10.78  15.06   5.10    7.63   6.89  0.00 108.19 108.19 2.68\ncaffeine    3 651 180.24 145.66 140.32  163.46 144.68  0.22 693.09 692.87 0.89\nbd          4 651  -0.34   0.55  -0.35   -0.34   0.59 -1.78   1.19   2.97 0.03\n         kurtosis   se\nstress      -0.10 0.36\nalcohol      9.34 0.59\ncaffeine     0.08 5.71\nbd          -0.28 0.02\n------------------------------------------------------------ \ntreatment: 1\n         vars   n   mean     sd median trimmed    mad   min    max  range  skew\nstress      1 349  21.46  10.47  20.48   21.18  12.20  0.62  40.00  39.38  0.21\nalcohol     2 349  18.47  23.38   9.47   13.97  12.96  0.00 142.97 142.97  2.30\ncaffeine    3 349 231.16 166.58 199.42  217.70 187.19  1.69 708.31 706.62  0.61\nbd          4 349  -0.98   0.57  -0.96   -0.98   0.61 -2.58   0.82   3.40 -0.01\n         kurtosis   se\nstress      -0.96 0.56\nalcohol      6.69 1.25\ncaffeine    -0.58 8.92\nbd          -0.19 0.03\n```\n\n\n:::\n\n```{.r .cell-code}\n# Naive model that tests bp difference without accounting for covariates\nmeans  = cohort_c |> group_by(treatment) |> summarize(mean(bd))\neffect = as.numeric(means[2,2]-means[1,2])\neffect\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] -0.639786\n```\n\n\n:::\n\n```{.r .cell-code}\n# Cohort A has no covariate or treatment effects. Both treated (smokers) and control (non-smokers)\n# should have the same distribution of bone density (bd)\np1 = ggplot() + geom_density(data=cohort_a |> filter(treatment==T),aes(bd),color=palette[1]) +\n  geom_density(data=cohort_a |> filter(treatment==F),aes(bd),color=\"black\") +\n  geom_vline(xintercept = cohort_a |> filter(treatment==T) |> select(bd) |> as_vector() |> mean(),color=palette[1]) +\n  geom_vline(xintercept = cohort_a |> filter(treatment==F) |> select(bd) |> as_vector() |> mean()) +\n  scale_x_continuous(lim=c(-2,2),breaks=seq(-2,2,by=0.5))\n\n# The magnitude of the covariate effect.\np2 = ggplot() + geom_density(data=cohort_b |> filter(treatment==T),aes(bd_covariate_effect),color=palette[1]) +\n  geom_density(data=cohort_b |> filter(treatment==F),aes(bd_covariate_effect),color=\"black\") +\n  geom_vline(xintercept = cohort_b |> filter(treatment==T) |> select(bd_covariate_effect) |> as_vector() |> mean(),color=palette[1]) +\n  geom_vline(xintercept = cohort_b |> filter(treatment==F) |> select(bd_covariate_effect) |> as_vector() |> mean()) +\n  scale_x_continuous(lim=c(-2,2),breaks=seq(-2,2,by=0.5))\n\n# Treatment probability.\np2b = ggplot() + geom_density(data=cohort_b |> filter(treatment==T),aes(treatment_p),color=palette[1]) +\n  geom_density(data=cohort_b |> filter(treatment==F),aes(treatment_p),color=\"black\") +\n  geom_vline(xintercept = cohort_b |> filter(treatment==T) |> select(treatment_p) |> as_vector() |> mean(),color=palette[1]) +\n  geom_vline(xintercept = cohort_b |> filter(treatment==F) |> select(treatment_p) |> as_vector() |> mean()) +\n  scale_x_continuous(lim=c(0,1),breaks=seq(0,1,by=.2))\n  \n# Cohort B : covariate effect but no treatment effect\np3 = ggplot() + geom_density(data=cohort_b |> filter(treatment==T),aes(bd),color=palette[1]) +\n  geom_density(data=cohort_b |> filter(treatment==F),aes(bd),color=\"black\") +\n  geom_vline(xintercept = cohort_b |> filter(treatment==T) |> select(bd) |> as_vector() |> mean(),color=palette[1]) +\n  geom_vline(xintercept = cohort_b |> filter(treatment==F) |> select(bd) |> as_vector() |> mean()) +\n  scale_x_continuous(lim=c(-2,2),breaks=seq(-2,2,by=0.5))\n\n# Cohort B : covariate and treatment effect\np4 = ggplot() + geom_density(data=cohort_c |> filter(treatment==T),aes(bd),color=palette[1]) +\n  geom_density(data=cohort_c |> filter(treatment==F),aes(bd),color=\"black\") +\n  geom_vline(xintercept = cohort_c |> filter(treatment==T) |> select(bd) |> as_vector() |> mean(),color=palette[1]) +\n  geom_vline(xintercept = cohort_c |> filter(treatment==F) |> select(bd) |> as_vector() |> mean()) +\n  scale_x_continuous(lim=c(-2,2),breaks=seq(-2,2,by=0.5))\n\nmultiplot(plot_theme(p1,aspect),plot_theme(p2,aspect),plot_theme(p2b,aspect),plot_theme(p3,aspect),plot_theme(p4,aspect),cols=1)\n```\n\n::: {.cell-output-display}\n![](PSM_NatureMethods_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n\n```{.r .cell-code}\ndev.copy2pdf(file = \"fig-distributions.pdf\",useDingbats=FALSE,width=5,height=3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npng \n  2 \n```\n\n\n:::\n\n```{.r .cell-code}\ncohort        = cohort_c\nmodel_matched = lm(bd ~ treatment, \n                    data = cohort_c)\nsummary(model_matched)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = bd ~ treatment, data = cohort_c)\n\nResiduals:\n     Min       1Q   Median       3Q      Max \n-1.60017 -0.40313  0.00176  0.39403  1.80181 \n\nCoefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept) -0.34018    0.02179  -15.61   <2e-16 ***\ntreatment   -0.63979    0.03689  -17.34   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 0.556 on 998 degrees of freedom\nMultiple R-squared:  0.2316,\tAdjusted R-squared:  0.2309 \nF-statistic: 300.9 on 1 and 998 DF,  p-value: < 2.2e-16\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# propensity score matching with replacement\nmatched_data = matchit(treatment ~ alcohol + stress + caffeine,\n                        data     = cohort,\n                        method   = \"nearest\",\n                        replace  = TRUE,\n                        caliper  = 0.1)\n\ncohort$w   = matched_data$weights\ncohort$ps  = matched_data$distance\ncohort$cat = 0\n\ncohort[cohort$w == 0 & cohort$treatment==F,]$cat=-2  # unmatched control\ncohort[cohort$w == 0 & cohort$treatment==T,]$cat=-1  # unmatched treat\ncohort[cohort$w > 0  & cohort$treatment==F,]$cat=0   # matched   control\ncohort[cohort$w > 0  & cohort$treatment==T,]$cat=1   # matched   treat\ncohort |> count(cat)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 4 × 2\n    cat     n\n  <dbl> <int>\n1    -2   416\n2    -1     5\n3     0   235\n4     1   344\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\naspect = 1/3 # for plots\n\n# full cohort\n# plot densities of alcohol, stress, caffine\n\nvarT = cohort|>filter(treatment==T)|>select(alcohol)\nvarF = cohort|>filter(treatment==F)|>select(alcohol)\np1 = ggplot() + \n    geom_density(data=varF,aes(alcohol),color=\"black\",size=1) +\n    geom_density(data=varT,aes(alcohol),color=palette[1],size=1) +\n    geom_vline(xintercept=varF|>as_vector()|>mean(),color=\"black\") +\n    geom_vline(xintercept=varT|>as_vector()|>mean(),color=palette[1]) +\n    annotate(\"text\",x=varF|>as_vector()|>mean()-1,y=0,label=varF|>as_vector()|>mean()|>round(1),color=\"black\",size=3,hjust=1) +\n    annotate(\"text\",x=varT|>as_vector()|>mean()+1,y=0,label=varT|>as_vector()|>mean()|>round(1),color=palette[1],size=3,hjust=0) +\n  scale_x_continuous(lim=c(0,100)) +\n  scale_y_continuous(lim=c(0,0.1))\n\nvarT = cohort|>filter(treatment==T)|>select(stress)\nvarF = cohort|>filter(treatment==F)|>select(stress)\np2 = ggplot() + \n    geom_density(data=varF,aes(stress),color=\"black\",size=1) +\n    geom_density(data=varT,aes(stress),color=palette[1],size=1) +\n    geom_vline(xintercept=varF|>as_vector()|>mean(),color=\"black\") +\n    geom_vline(xintercept=varT|>as_vector()|>mean(),color=palette[1]) +\n    annotate(\"text\",x=varF|>as_vector()|>mean()-5,y=0,label=varF|>as_vector()|>mean()|>round(1),color=\"black\",size=3,hjust=1) +\n    annotate(\"text\",x=varT|>as_vector()|>mean()+5,y=0,label=varT|>as_vector()|>mean()|>round(1),color=palette[1],size=3,hjust=0) +\n  scale_x_continuous(lim=c(0,40)) +\n  scale_y_continuous(lim=c(0,0.06))\n\nvarT = cohort|>filter(treatment==T)|>select(caffeine)\nvarF = cohort|>filter(treatment==F)|>select(caffeine)\np3 = ggplot() + \n    geom_density(data=varF,aes(caffeine),color=\"black\",size=1) +\n    geom_density(data=varT,aes(caffeine),color=palette[1],size=1) +\n    geom_vline(xintercept=varF|>as_vector()|>mean(),color=\"black\") +\n    geom_vline(xintercept=varT|>as_vector()|>mean(),color=palette[1]) +\n    annotate(\"text\",x=varF|>as_vector()|>mean()-1,y=0,label=varF|>as_vector()|>mean()|>round(1),color=\"black\",size=3,hjust=1) +\n    annotate(\"text\",x=varT|>as_vector()|>mean()+1,y=0,label=varT|>as_vector()|>mean()|>round(1),color=palette[1],size=3,hjust=0) + \n    scale_x_continuous(lim=c(0,400),breaks=seq(0,400,by=50)) +\n    scale_y_continuous(lim=c(0,0.006))\n\nmultiplot(plot_theme(p1,aspect),plot_theme(p2,aspect),plot_theme(p3,aspect),cols=1)\n```\n\n::: {.cell-output-display}\n![](PSM_NatureMethods_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n\n```{.r .cell-code}\ndev.copy2pdf(file = \"fig2a.pdf\",useDingbats=FALSE,width=5,height=3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npng \n  2 \n```\n\n\n:::\n\n```{.r .cell-code}\n# matched/unmatched\n# plot densities of alcohol, cholesterol, caffeine\n\nvarT   = cohort[matched_data$weights>0,]|>filter(treatment==T)|>select(alcohol)\nvarF   = cohort[matched_data$weights>0,]|>filter(treatment==F)|>select(alcohol)\nvarFun = cohort[matched_data$weights==0,]|>filter(treatment==F)|>select(alcohol)\np1 = ggplot() + \n    geom_density(data=varF,aes(alcohol),color=\"black\",size=1) +\n    geom_density(data=varT,aes(alcohol),color=palette[1],size=1) +\n    geom_density(data=varFun,aes(alcohol),color=palette[2],size=1) +\n    geom_vline(xintercept=varF|>as_vector()|>mean(),color=\"black\") +\n    geom_vline(xintercept=varT|>as_vector()|>mean(),color=palette[1]) +\n    geom_vline(xintercept=varFun|>as_vector()|>mean(),color=palette[2]) +\n    annotate(\"text\",x=varF|>as_vector()|>mean()-1,y=0,label=varF|>as_vector()|>mean()|>round(1),color=\"black\",size=3,hjust=1) +\n    annotate(\"text\",x=varFun|>as_vector()|>mean()-1,y=0,label=varFun|>as_vector()|>mean()|>round(1),color=palette[2],size=3,hjust=1) +\n    annotate(\"text\",x=varT|>as_vector()|>mean()+1,y=0,label=varT|>as_vector()|>mean()|>round(1),color=palette[1],size=3,hjust=0) +\n  scale_x_continuous(lim=c(0,100)) +\n  scale_y_continuous(lim=c(0,0.1))\n\nvarT   = cohort[matched_data$weights>0,]|>filter(treatment==T)|>select(stress)\nvarF   = cohort[matched_data$weights>0,]|>filter(treatment==F)|>select(stress)\nvarFun = cohort[matched_data$weights==0,]|>filter(treatment==F)|>select(stress)\np2 = ggplot() + \n    geom_density(data=varF,aes(stress),color=\"black\",size=1) +\n    geom_density(data=varT,aes(stress),color=palette[1],size=1) +\n    geom_density(data=varFun,aes(stress),color=palette[2],size=1) +\n    geom_vline(xintercept=varF|>as_vector()|>mean(),color=\"black\") +\n    geom_vline(xintercept=varT|>as_vector()|>mean(),color=palette[1]) +\n    geom_vline(xintercept=varFun|>as_vector()|>mean(),color=palette[2]) +\n    annotate(\"text\",x=varF|>as_vector()|>mean()-1,y=0,label=varF|>as_vector()|>mean()|>round(1),color=\"black\",size=3,hjust=1) +\n    annotate(\"text\",x=varFun|>as_vector()|>mean()-1,y=0,label=varFun|>as_vector()|>mean()|>round(1),color=palette[2],size=3,hjust=1) +\n    annotate(\"text\",x=varT|>as_vector()|>mean()+1,y=0,label=varT|>as_vector()|>mean()|>round(1),color=palette[1],size=3,hjust=0) +\n  scale_x_continuous(lim=c(0,40)) +\n  scale_y_continuous(lim=c(0,0.06))\n\nvarT   = cohort[matched_data$weights>0,]|>filter(treatment==T)|>select(caffeine)\nvarF   = cohort[matched_data$weights>0,]|>filter(treatment==F)|>select(caffeine)\nvarFun = cohort[matched_data$weights==0,]|>filter(treatment==F)|>select(caffeine)\np3 = ggplot() + \n    geom_density(data=varF,aes(caffeine),color=\"black\",size=1) +\n    geom_density(data=varT,aes(caffeine),color=palette[1],size=1) +\n    geom_density(data=varFun,aes(caffeine),color=palette[2],size=1) +\n    geom_vline(xintercept=varF|>as_vector()|>mean(),color=\"black\") +\n    geom_vline(xintercept=varT|>as_vector()|>mean(),color=palette[1]) +\n    geom_vline(xintercept=varFun|>as_vector()|>mean(),color=palette[2]) +\n    annotate(\"text\",x=varF|>as_vector()|>mean()-1,y=0,label=varF|>as_vector()|>mean()|>round(1),color=\"black\",size=3,hjust=1) +\n    annotate(\"text\",x=varFun|>as_vector()|>mean()-1,y=0,label=varFun|>as_vector()|>mean()|>round(1),color=palette[2],size=3,hjust=1) +\n    annotate(\"text\",x=varT|>as_vector()|>mean()+1,y=0,label=varT|>as_vector()|>mean()|>round(1),color=palette[1],size=3,hjust=0) +\n    scale_x_continuous(lim=c(0,400),breaks=seq(0,400,by=50)) +\n    scale_y_continuous(lim=c(0,0.006))\n\nmultiplot(plot_theme(p1,aspect),plot_theme(p2,aspect),plot_theme(p3,aspect),cols=1)\n```\n\n::: {.cell-output-display}\n![](PSM_NatureMethods_files/figure-html/unnamed-chunk-3-2.png){width=672}\n:::\n\n```{.r .cell-code}\ndev.copy2pdf(file = \"fig2b.pdf\",useDingbats=FALSE,width=5,height=3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npng \n  2 \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npdf(\"fig3a.pdf\")\nplot(matched_data, type = \"jitter\", interactive = FALSE)\ndev.off()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npng \n  2 \n```\n\n\n:::\n\n```{.r .cell-code}\npdf(\"fig3b.pdf\")\nlove.plot(matched_data, binary = \"std\")\ndev.off()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npng \n  2 \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# get the matched data set\nmatched_data_for_real = match.data(matched_data)\nmatched_data_for_real |> nrow()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 579\n```\n\n\n:::\n\n```{.r .cell-code}\n# new linear model with matched data\nmodel_matched = lm(bd ~ treatment, \n                    data = matched_data_for_real)\nsummary(model_matched)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = bd ~ treatment, data = matched_data_for_real)\n\nResiduals:\n    Min      1Q  Median      3Q     Max \n-1.6067 -0.3913  0.0018  0.3920  1.7953 \n\nCoefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept) -0.42417    0.03647  -11.63   <2e-16 ***\ntreatment   -0.54927    0.04732  -11.61   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 0.5591 on 577 degrees of freedom\nMultiple R-squared:  0.1893,\tAdjusted R-squared:  0.1879 \nF-statistic: 134.7 on 1 and 577 DF,  p-value: < 2.2e-16\n```\n\n\n:::\n\n```{.r .cell-code}\n# get the same result by comparing means\nmatched_data_for_real |>\n  filter(treatment==T) |>\n  summarize(blood_mean=mean(bd)) -\n  matched_data_for_real |>\n  filter(treatment==F) |>\n  summarize(blood_mean=mean(bd))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  blood_mean\n1 -0.5492713\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# jitter plot of unmatched data (entire cohort)\nbd_min = -3\nbd_max = 1.5\np1 = ggplot(cohort, aes(x=treatment, y=bd)) +  \n  geom_jitter(width=0.2,shape=16,size=0.5) +\n  stat_summary(fun = \"mean\", geom = \"crossbar\", width = .5, color = \"orange\") +\n  annotate(\"text\", x = 0.25, y = 0, hjust=0,size=3,label = cohort |> \n             filter(treatment==F) |> \n             select(bd) |> as_vector() |> mean() |> round(2)) +\n  annotate(\"text\", x = 1.25, y = 0, hjust=0,size=3,label = cohort |> \n             filter(treatment==T) |> \n             select(bd) |> as_vector() |> mean() |> round(2)) +\n  scale_x_continuous(lim=c(-2.25,1.75))  +\n  scale_y_continuous(lim=c(bd_min,bd_max),breaks=seq(bd_min,bd_max,by=1))\n# jitter plot of matched data \np2 = ggplot(cohort, aes(x=cat, y=bd)) +  \n  geom_jitter(width=0.2,shape=16,size=0.5) +\n  stat_summary(fun = \"mean\", geom = \"crossbar\", width = .5, color = \"orange\") +\n  annotate(\"text\",x=-1.75,y=0,hjust=0,size=3,\n             label=cohort|>filter(cat==-2)|>select(bd) |> as_vector() |> mean() |> round(1)) +\n  annotate(\"text\",x=-0.75,y=0,hjust=0,size=3,\n             label=cohort|>filter(cat==-1)|>select(bd) |> as_vector() |> mean() |> round(2)) +\n  annotate(\"text\",x=0.25,y=0,hjust=0,size=3,\n             label=cohort|>filter(cat==0)|>select(bd) |> as_vector() |> mean() |> round(2)) +\n  annotate(\"text\",x=1.25,y=0,hjust=0,size=3,\n             label=cohort|>filter(cat==1)|>select(bd) |> as_vector() |> mean() |> round(2)) +\n  scale_x_continuous(lim=c(-2.25,1.75)) +\n  scale_y_continuous(lim=c(bd_min,bd_max),breaks=seq(bd_min,bd_max,by=1))\n\n# linear model with weights\nmodel_matched_wts = lm(bd ~ treatment, \n                        data = matched_data_for_real,\n                        weights = weights)\nsummary(model_matched_wts)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = bd ~ treatment, data = matched_data_for_real, weights = weights)\n\nWeighted Residuals:\n     Min       1Q   Median       3Q      Max \n-1.93615 -0.36786  0.01487  0.37422  1.79528 \n\nCoefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept) -0.45059    0.03663   -12.3   <2e-16 ***\ntreatment   -0.52286    0.04753   -11.0   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 0.5616 on 577 degrees of freedom\nMultiple R-squared:  0.1734,\tAdjusted R-squared:  0.1719 \nF-statistic:   121 on 1 and 577 DF,  p-value: < 2.2e-16\n```\n\n\n:::\n\n```{.r .cell-code}\ndata = matched_data_for_real \n# plot\nwmean_f = as.numeric(data|>filter(treatment==F)|>select(bd, weights) |> summarize(weighted_mean=weighted.mean(bd, weights)))\nwmean_t = as.numeric(data|>filter(treatment==T)|>select(bd, weights) |> summarize(weighted_mean=weighted.mean(bd, weights)))\np3 = ggplot(data, aes(x=treatment, y=bd)) +  \n  geom_jitter(width=0.2,shape=16,size=scales::rescale(matched_data_for_real$weights, to=c(0.25, 1.25))) +\n  annotate(\"segment\",x=-0.25,y = as.numeric(wmean_f), xend=0.25, yend = as.numeric(wmean_f), color=\"orange\")+\n  annotate(\"segment\",x=0.75,y = as.numeric(wmean_t), xend=1.25, yend = as.numeric(wmean_t), color=\"orange\")+\n  annotate(\"text\",x=0.25,y=wmean_f,hjust=0,size=3,label=wmean_f |> round(2)) +\n  annotate(\"text\",x=1.25,y=wmean_t,hjust=0,size=3,label=wmean_t |> round(2)) +\n  scale_x_continuous(lim=c(-2.25,1.75)) +\n  scale_y_continuous(lim=c(bd_min,bd_max),breaks=seq(bd_min,bd_max,by=1))\n\naspect = 1\nmultiplot(plot_theme(p1,aspect),plot_theme(p2,aspect),plot_theme(p3,aspect),cols=3)\n```\n\n::: {.cell-output-display}\n![](PSM_NatureMethods_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n\n```{.r .cell-code}\ndev.copy2pdf(file = \"fig4.pdf\",useDingbats=FALSE,width=5,height=2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npng \n  2 \n```\n\n\n:::\n\n```{.r .cell-code}\nmodel_matched_wts\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = bd ~ treatment, data = matched_data_for_real, weights = weights)\n\nCoefficients:\n(Intercept)    treatment  \n    -0.4506      -0.5229  \n```\n\n\n:::\n:::\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 323\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = bd ~ treatment, data = matched_data_noreplace_for_real)\n\nResiduals:\n     Min       1Q   Median       3Q      Max \n-1.62875 -0.39014 -0.01118  0.38694  1.77323 \n\nCoefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept) -0.41094    0.03063  -13.42   <2e-16 ***\ntreatment   -0.54045    0.04331  -12.48   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 0.5504 on 644 degrees of freedom\nMultiple R-squared:  0.1947,\tAdjusted R-squared:  0.1934 \nF-statistic: 155.7 on 1 and 644 DF,  p-value: < 2.2e-16\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\npng \n  2 \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\npng \n  2 \n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 4 × 2\n    cat     n\n  <dbl> <int>\n1    -2   328\n2    -1    26\n3     0   323\n4     1   323\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# mahalanobis matching, not used \nmaha_matched = matchit(treatment ~ alcohol + stress + caffeine,\n                                              data = cohort,\n           distance = \"mahalanobis\", replace = TRUE)\nmatched_data_maha = match.data(maha_matched)\nmodel_maha_matched = lm(bd ~ treatment, \n                    data = matched_data_maha)\nsummary(model_maha_matched)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = bd ~ treatment, data = matched_data_maha)\n\nResiduals:\n     Min       1Q   Median       3Q      Max \n-1.60017 -0.39327 -0.01058  0.38729  1.80181 \n\nCoefficients:\n            Estimate Std. Error t value Pr(>|t|)    \n(Intercept) -0.41493    0.03641  -11.39   <2e-16 ***\ntreatment   -0.56504    0.04710  -12.00   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 0.5582 on 582 degrees of freedom\nMultiple R-squared:  0.1982,\tAdjusted R-squared:  0.1969 \nF-statistic: 143.9 on 1 and 582 DF,  p-value: < 2.2e-16\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# propensity score matching with replacement\neffect_by_caliper = function(caliper=0.1,replace=TRUE) {\nmatched_data = matchit(treatment ~ alcohol + stress + caffeine,\n                        data     = cohort,\n                        method   = \"nearest\",\n                        replace  = replace,\n                        caliper  = caliper)\n# get the matched data set\nmatched_data_for_real = match.data(matched_data)\nn = matched_data_for_real |> filter(treatment==T) |> filter(weights>0) |> nrow()\nd = matched_data_for_real |>\n    filter(treatment==T) |>\n    summarize(bd_mean=mean(bd)) -\n    matched_data_for_real |>\n    filter(treatment==F) |>\n    summarize(bd_mean=mean(bd))\nreturn(c(n=as.numeric(n),d=as.numeric(d)))\n}\ncalipers   = seq(0.01,1,by=0.01)\neffects_r  = sapply(calipers,FUN=effect_by_caliper,replace=TRUE)\neffects_nr = sapply(calipers,FUN=effect_by_caliper,replace=FALSE)\np1 = ggplot(data=data.frame(x=calipers,yr=effects_r[1,],ynr=effects_nr[1,])) + geom_line(aes(x=x,y=yr)) + geom_line(aes(x=x,y=ynr),color=\"brown\")\np2 = ggplot(data=data.frame(x=calipers,yr=effects_r[2,],ynr=effects_nr[2,])) + geom_line(aes(x=x,y=yr)) + geom_line(aes(x=x,y=ynr),color=\"brown\")\nmultiplot(plot_theme(p1,aspect),plot_theme(p2,aspect),cols=2)\n```\n\n::: {.cell-output-display}\n![](PSM_NatureMethods_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n\n```{.r .cell-code}\ndev.copy2pdf(file = \"fig5.pdf\",useDingbats=FALSE,width=6,height=3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\npng \n  2 \n```\n\n\n:::\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}